---
author: '013-涂靖昊'
---

# 3 中断和异常处理

## 3.1 中断和异常处理概述

<!-- 
* 什么是中断和异常
* 处理器如何处理
思考: 实模式和保护模式下, 中断向量表一样吗?
 -->

> 什么是中断和异常?

中断和异常是表明系统, 处理器中当前正在执行的程序或任务中存在需要处理器注意的事件.

> 处理器怎么处理中断和异常?

中断和异常通常会导致处理器从当前运行的程序或任务强制转移到称为中断处理程序或一场处理程序的特殊软件程序或任务.

> 思考: 实模式和保护模式下, 中断向量表相同吗?

实模式和保护模式下的中断向量表是不同的.
在实模式下, 中断型量表是一个固定的内存区域. 在保护模式下, 中断向量表是一个可修改的系统段描述符.

1. 在实模式下, 中断向量表是一个 1 KB 的内脆嫩区域, 位于物理内存地址 0x0000-0x03FF.
    中断向量表中包含了 256 个 4 KB 的中断向量, 每个中断向量包含了中断处理程序的入口地址和段选择子.
    实模式下的中断向量表是固定的, 无法修改.
2. 在保护模式下, 中断向量表是一个系统段描述符, 位于全局描述符 GDT 中.
    中断向量表中包含了 256 个 8 Byte 的中断门描述符, 每个中断门描述符包含了中断处理程序的段选择子, 偏移量和访问权限等信息.
    保护模式下的中断向量表可以通过修改 GDT 来修改.

## 3.2 有关中断和异常了解性的内容

<!-- 
* 中断和异常向量
* 中断源和异常源
* 异常的分类: 故障, 陷阱和中止
* 程序或任务的重新执行
* 开启和禁止中断
* 异常和中断的优先级
 -->

> 中断和异常向量

中断和异常向量是用于标识中断和异常类型的数字或代码. 在处理器中, 中断和异常向量通常被映射到中断向量表或异常向量表中, 用于查找中断处理程序或异常处理程序的入口地址.

> 中断源和异常源

中断源和异常源是指导致中断或异常的硬件设备或软件事件. 中断源通常是硬件设备, 例如键盘, 鼠标, 网卡等, 而异常源通常是软件事件, 例如除零错误, 非法指令等.

> 异常的分类

异常可以分为三种类型: 故障、陷阱和中止. 故障是指由于错误的操作或数据导致的异常, 例如除零错误、非法指令等; 陷阱是指由于程序需要而产生的异常, 例如系统调用、断点等; 中止是指由于某些不可恢复的错误导致的异常, 例如硬件故障、内存错误等.

> 程序或任务的重新执行

当处理器从中断或异常处理程序返回时, 它通常会重新执行被中断或异常中断的程序或任务. 在某些情况下, 处理器可能会在中断或异常处理程序中修改程序或任务的状态, 以便重新执行时能够正确地恢复.

> 开启和禁止中断

处理器通常提供了一些特殊的指令或寄存器, 用于开启或禁止中断. 开启中断意味着处理器将响应中断请求, 而禁止中断则意味着处理器将忽略中断请求.

> 异常和中断的优先级

处理器通常会为不同的异常和中断分配优先级, 以便在多个异常或中断同时发生时进行处理. 优先级高的异常或中断将优先得到处理, 而优先级低的异常或中断则可能被延迟处理或忽略.

## 3.3 中断描述符表

<!-- 
* 如何构成
* 如何获得中断处理程序的地址?
* 如何设置中断描述符表寄存器
 -->

> 中断描述符表的构成

1. 中断描述符表是一个系统段描述符, 位于 GDT 中.
2. 中断描述符表中包含了 256 个中断门描述符, 每个中断门描述符占用 8 个字节.
3. 每个中断门描述符包含了中断处理程序的段选择子, 偏移量和访问权限等信息.
4. 中断门描述符中的段选择子指向中断处理程序所在的代码段, 便宜两制定了中断处理程序在代码段中的偏移地址.
5. 中断门描述符中的访问权限用于指定中断处理程序的特权级别和访问方式等信息.

> 如何获得中断处理程序的地址?

在中断描述符表中, 每个中断门描述符包含了中断处理程序的段选择子和偏移量等信息.
获得中断处理程序的地址的步骤:

1. 从中断向量号中获取中断门描述符的索引. 中断向量号是一个用于标识中断类型的数字或代码, 它通常由中断源或异常源提供.
2. 从中断描述符表中获取对应的中断门描述符. 中断描述符表是一个系统段描述符, 位于全局描述符表 (GDT) 中.
3. 从中断门描述符中获取中断处理程序的段选择子和偏移量. 中断处理程序的段选择子指向中断处理程序所在的代码段, 偏移量指定了中断处理程序在代码段中的偏移地址.
4. 将中断处理程序的段选择子和偏移量组合起来, 得到中断处理程序的线性地址.

> 如何设置中断描述符表寄存器?

1. 创建一个中断描述符表, 包含所有中断处理程序的入口地址和访问权限等信息.
2. 将中断描述符表的起始地址加载道中断描述符表寄存器 (IDTR) 中.
    > IDTR 是一个 48 位的寄存器, 其中包含了中断描述符表的起始地址和长度等信息.
    > 要加载中断描述符表的起始地址, 需要将地址的低 32 位写入 IDTR 的低 32 位中,
    > 将地址的高 16 位写入 IDTR 的高 16 位中, 将地址的第 48 位设置为 0.
3. 开启中断. 在 x86 架构中, 可以使用 sti 指令开启中断, 使用 cli 指令关闭中断.

## 3.4 IDT 描述符

<!-- 
掌握以下描述符格式:
* 中断门
* 陷阱门
* 任务门
 -->

### 3.4.1 中断门

中断门 (Interrupt Gate) 是一种用于处理中断和异常的描述符类型, 它是中断描述符表中的一种. 中断门描述符包含了中断处理程序的段选择子, 偏移量和访问权限等信息.

中断门描述符的格式如下：

```none
  31             16 15              0
 +-----------------+-----------------+
 | Offset 15...0   | Selector        | 0
 +-----------------+-----------------+
 | Access Byte     | Offset 31...16  | 4
 +-----------------+-----------------+
```

其中, Offset 15...0 和 Offset 31...16 分别指定了中断处理程序在代码段中的偏移量, Selector 指定了中断处理程序所在的代码段的段选择子, Access Byte 指定了中断门的访问权限和特权级别等信息.

中断门与陷阱门的区别在于, 中断门会自动开启中断, 而陷阱门不会. 当处理器执行中断门时, 会自动将中断标志位清零, 以避免在中断处理程序执行期间再次触发中断.

因此, 中断门是一种用于处理中断和异常的描述符类型, 它包含了中断处理程序的段选择子, 偏移量和访问权限等信息. 与陷阱门不同, 中断门会自动开启中断.

### 3.4.2 陷阱门

陷阱门 (Trap Gate) 是一种用于处理陷阱和系统调用的描述符类型, 它是中断描述符表中的一种. 陷阱门描述符包含了陷阱处理程序的段选择子, 偏移量和访问权限等信息.

陷阱门描述符的格式与中断门描述符相同, 如下所示:

```none
  31             16 15              0
 +-----------------+-----------------+
 | Offset 15...0   | Selector        | 0
 +-----------------+-----------------+
 | Access Byte     | Offset 31...16  | 4
 +-----------------+-----------------+
```

其中, Offset 15...0 和 Offset 31...16 分别指定了陷阱处理程序在代码段中的偏移量, Selector 指定了陷阱处理程序所在的代码段的段选择子, Access Byte 指定了陷阱门的访问权限和特权级别等信息.

与中断门不同, 陷阱门不会自动开启中断. 当处理器执行陷阱门时, 中断标志位不会被清零, 因此在陷阱处理程序执行期间仍然可以触发中断. 陷阱门通常用于实现系统调用和陷阱指令等功能.

因此, 陷阱门是一种用于处理陷阱和系统调用的描述符类型, 它包含了陷阱处理程序的段选择子, 偏移量和访问权限等信息. 与中断门不同, 陷阱门不会自动开启中断.

### 3.4.3 任务门

任务门 (Task Gate) 是一种用于实现任务切换的描述符类型, 它是任务状态段 (TSS) 中的一种. 任务门描述符包含了任务状态段的段选择子和特权级别等信息.

任务门描述符的格式如下:

```none
  31             16 15              0
 +-----------------+-----------------+
 | TSS Segment     | 0               | 0
 +-----------------+-----------------+
 | Access Byte     | TSS Segment     | 4
 +-----------------+-----------------+
```

其中, TSS Segment 指定了任务状态段的段选择子, Access Byte 指定了任务门的访问权限和特权级别等信息.

任务门通常用于实现任务切换, 当处理器执行任务门时, 会自动将当前任务的状态保存到任务状态段中, 并加载新任务的状态. 任务门可以实现任务间的快速切换, 提高系统的并发性能.

因此, 任务门是一种用于实现任务切换的描述符类型, 它包含了任务状态段的段选择子和特权级别等信息. 任务门通常用于实现任务间的快速切换, 提高系统的并发性能.

## 3.5 中断与异常处理

<!-- 
* 中断过程调用的流程是怎样的?
* 如何判断中断处理过程与被中断任务的优先级?
* 不同优先级上, 处理方式一样吗?
* 如果发生堆栈切换, 处理器会做哪些操作?
* 如果没发生堆栈切换, 处理器会做哪些操作?
* 中断处理过程后, 如何返回, 处理器做了哪些操作?
* 异常和中断处理过程的保护
* 异常和中断处理过程的标志使用方式
* 中断门与陷阱门的唯一区别是什么?
 -->

> 中断过程调用的流程是什么?

1. 当外部设备发生中断时, 处理器会暂停当前任务的执行, 保存当前任务的上下文信息 (包括程序计数器, 标志寄存器, 通用寄存器等) 到当前任务的内核栈中, 并将中断标志位置为 1, 以禁止其他中断的发生.
2. 处理器根据中断向量号从中断描述符表中获取对应的中断门描述符, 并根据中断门描述符中的段选择子和偏移量计算出中断处理程序的线性地址.
3. 处理器将中断处理程序的段选择子和偏移量加载到代码段寄存器和程序计数器中, 并开始执行中断处理程序.
4. 中断处理程序执行完毕后, 处理器从内核栈中恢复当前任务的上下文信息, 并将中断标志位恢复为原来的值, 以允许其他中断的发生.
5. 处理器根据返回地址返回到中断发生时的代码位置, 继续执行当前任务.

> 如何判断中断处理过程与被中断任务的优先级?

中断处理程序和被中断任务的优先级是通过中断向量和中断门描述符中的特权级别来判断的.
中断处理程序的特权级别通常要高于被中断任务的特权级别.

当处理器执行中断门时, 会检查中断门描述符中的特权级别是否大于等于当前任务的特权级别. 如果中断门描述符中的特权级别大于等于当前任务的特权级别, 则处理器会将当前任务的上下文信息保存到内核栈中, 并开始执行中断处理程序. 如果中断门描述符中的特权级别小于当前任务的特权级别, 则处理器会忽略中断请求, 继续执行当前任务.

> 不同优先级上, 处理方式一样吗?

不同优先级的中断处理方式可能不一样. 在 x86 架构中, 处理器支持多种不同的中断和异常, 每种中断和异常都有自己的处理方式和优先级.
处理器通过中断向量号和中断门描述符中的特权级别来判断中断的优先级和处理方式.

> 如果发生堆栈切换, 处理器会做哪些操作?

如果发生堆栈切换，处理器会执行以下操作：

1. 将当前任务的上下文信息 (包括程序计数器, 标志寄存器, 通用寄存器等) 保存到当前任务的内核栈中.
2. 将新任务的上下文信息 (包括程序计数器, 标志寄存器, 通用寄存器等) 从新任务的内核栈中加载到寄存器中.
3. 将新任务的内核栈指针 (ESP) 加载到堆栈寄存器 (ESP) 中, 以切换到新任务的内核栈.
4. 将新任务的段选择子加载到段寄存器中, 以切换到新任务的代码段和数据段.
5. 将中断标志位恢复为原来的值, 以允许其他中断的发生.
6. 处理器开始执行新任务的代码.

> 如果没发生堆栈切换, 处理器会做哪些操作?

如果没有发生堆栈切换, 处理器会继续执行当前任务的代码, 直到发生中断或异常.

> 中断处理过程后, 如何返回, 处理器做了哪些操作?

1. 处理器从内核栈中弹出当前任务的上下文信息, 包括程序计数器, 标志寄存器, 通用寄存器等.
2. 处理器将中断标志位恢复为原来的值, 以允许其他中断的发生.
3. 处理器根据返回地址返回到中断发生时的代码位置, 继续执行当前任务.

> 异常和中断处理过程的保护

异常和中断处理过程的保护是通过为每个任务分配独立的内核栈, 并使用特权级别来限制对内核栈的访问, 以保护当前任务的上下文信息不被篡改或覆盖.

> 异常和中断处理过程的标志使用方式

异常和中断处理过程的标志位包括中断标志位和处理器状态标志位.

中断标志位是处理器中的一个标志位, 用于控制中断的发生.
当中断标志位为 1 时, 处理器会禁止中断的发生; 当中断标志位为 0 时, 处理器允许中断的发生.
在异常和中断处理过程中, 处理器会将中断标志位设置为 1, 以禁止其他中断的发生.
在处理完异常和中断后, 处理器会将中断标志位恢复为原来的值, 以允许其他中断的发生.

处理器状态标志是处理器中的一组标志位, 用于记录处理器的状态信息.
处理器状态标志包括进位标志, 零标志, 符号标志, 溢出标志等.
在异常和中断处理过程中, 处理器可能会修改处理器状态标志的值, 以记录异常和中断的结果.
处理器状态标志的值可以通过指令来读取和修改.

> 中断门和陷阱门的唯一区别是什么?

中断门和陷阱门的唯一区别在于处理完中断或异常处理程序后是否允许其他中断的发生.
中断门允许其他中断的发生, 而陷阱门不允许其他中断的发生.
