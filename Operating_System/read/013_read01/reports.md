---
author: "013-涂靖昊"
allowed_elements: [img]
---

# x86 系统架构概览

## 1.1 系统级体系结构概览

<!-- 参考图 2.1, 需要了解图中的所有系统级寄存器和数据结构, 在后面的章节中都有介绍.
以下内容要重点掌握:
* Global and Local Descriptors Tables
* System Segments, Segment Descriptors, and Gates
* Task-State Segments and Task Gates
* Interrupt and Exception Handling
* Memory Management
* System Registers -->

<figure style="text-align: center;">
  <img src="images/img1.png" alt="IA-32 System-Level Registers and Data Structures", width="", height="", >
  <figcaption>IA-32 系统级寄存器和数据结构</figcaption>
</figure>

### 1.1.1 全局和本地描述符表

在保护模式下运行时, 所有内存访问都会通过全局描述符表 (GDT) 或可选的本地描述符表 (LDT), 这些表包含成为段描述符的条目.
段描述符提供段的基地址以及访问权限, 类型和使用信息.  
每个段描述符都有一个关联的段选择器. 段选择器为使用它的软件提供了 GDT 或者 LDT 的索引 (其关联段描述符的偏移量), 全局/局部标志 (确定选择器是指向 GDT 还是 LDT) 以及访问权限信息.

> 访问机制
> : 要访问段中的字节, 必须提供段选择器和偏移量. 段选择器提供对段 (在 GDT 或 LDT 中) 的段描述符的访问. 从段描述符中, 处理器获得线性地址空间中段的基地址. 然后, 偏移量提供字节相对于基地址的位置.  
>
> - 该机制可用于访问任何有效的代码, 数据或堆栈段, 前提是可以从处理器运行的当前权限级别 (CPL) 访问该段. CPL 被定义为当前执行代码段的保护级别.

### 1.1.2 系统段, 段描述符和门

TSS 和 LDT
: 除了构成程序或过程的执行环境的代码, 数据和堆栈段之外, 该体系结构还定义了两个系统段：任务状态段 (TSS) 和 LDT.

- GDT 不被视为段, 因为它不通过段选择器和段描述符来访问. TSS 和 LDT 具有为其定义的段描述符.

该架构还定义了一组称为门的特殊描述符 (调用门, 中断门, 陷阱门和人物门).
它们为系统过程和处理程序提供了受保护的网关, 这些系统过程和处理程序可以在与应用程序和大多数过程不同的权限级别上运行.  
例如, 对调用门的 CALL 可以提供对代码段中的过程调用, 该代码段的权限级别与当前代码段相同或在数字上低于当前代码段 (更高特权).
为了通过调用门访问过程, 调用过程 1 为调用门提供选择器. 然后, 处理器对调用过门执行访问权限检查, 将 CPL 与调用门的权限级别以及调用门指向的目标代码段相比较.

如果允许访问目标代码段, 处理器将获取目标代码段的段选择器以及从调用门到该代码段的偏移量. 如果调用需要更改权限级别, 处理器也会切换到目标权限级别的堆栈. 新堆栈的段选择器是从当前正在运行的任务的 TSS 中获取的.

### 1.1.3 任务状态段和任务门

任务状态段 TSS
: 1. TSS 定义了任务执行环境的状态.
: 2. 它包括通用寄存器, 段寄存器, EFLAGS 寄存器, EIP 寄存器以及带有三个堆栈段 (每个权限级别一个堆栈) 的堆栈指针的段选择器的状态.
: 3. TSS 还包括与任务相关联的 LDT 的段选择器以及分页结构层次结构的基地址

保护模式下的所有程序执行都发生在任务（称为当前任务）的上下文中. 当前任务的 TSS 的段选择器存储在任务寄存器中. 切换到任务最简单的方法是调用或跳转到新任务. 这里, 新任务的 TSS 的段选择器在 CALL 或 JMP 指令中给出.
在切换任务时，处理器执行以下操作:

1. 将当前任务的状态存储在当前 TSS 中.
2. 将新任务的段选择器加载到任务寄存器中.
3. 通过 GDT 中的段描述符访问新的 TSS.
4. 将新任务的状态从新 TSS 加载到通用寄存器, 段寄存器, LDTR, 控制寄存器 CR3 (分页结构层次结构的基地址), EFLAGS 寄存器和 EIP 寄存器中.
5. 开始执行新任务. 还可以通过任务门访问任务. 任务门类似于调用门，不同之处在于它提供对 TSS 而不是代码段的访问 (通过段选择器).

### 1.1.4 中断和异常处理

外部中断, 软件中断和异常都通过中断描述符表 (IDT) 来处理. IDT 存储一个门描述符的集合, 该集合提供对中断和异常处理程序的访问.

> 和 GDT 相同, IDT 也不是段.

IDT 基址的线性地址包含在 IDT 寄存器 (IDTR) 中.

IDT 中的门描述符可以是中断, 陷阱或者任务门描述符.  
为了访问中断或异常处理程序, 处理器首先通过 INT, INTO, INT 3 或 BOUND 指令从内部硬件, 外部中断控制器或软件接收中断向量 (中断号). 中断向量提供了 IDT 的索引.
如果所选择的门描述符是中断门或者陷阱门, 则以与调用门调用过程类似的方式访问关联的处理程序过程.
如果描述符是任务门, 则通过任务切换来访问处理程序.

### 1.1.5 内存管理

系统架构支持内存的直接物理寻址或虚拟内存 (通过分页). 当使用物理寻址时, 线性地址被视为物理地址. 使用分页时: 所有代码, 数据, 堆栈和系统段 (包括 GDT 和 IDT) 都可以进行分页, 并且仅将最近访问的页面保存在物理内存中.  
物理内存中页 (有时称为页框) 的位置包含在分页结构中. 这些结构驻留在物理内存中 (参见图 2-1 的 32 位分页情况).  
分页结构层次结构的基本物理地址包含在控制寄存器 CR3 中. 分页结构中的条目确定页框基址的物理地址, 访问权限和内存管理信息.  
为了使用这种分页机制, 线性地址被分成几部分. 这些部分提供了分页结构和页框的单独偏移. 系统可以具有单个或多个分页结构层次结构. 例如, 每个任务可以有自己的层次结构.

### 1.1.6 系统寄存器

为了帮助初始化处理器和控制系统操作，系统架构在 EFLAGS 寄存器和几个系统寄存器中提供了系统标志:

- EFLAGS 寄存器中的系统标志和 IOPL 字段控制任务和模式切换、中断处理、指令跟踪和访问权.
- 控制寄存器 (CR0, CR2, CR3 和 CR4) 包含用于控制系统级操作的各种标志和数据字段。这些寄存器中的其他标志用于指示操作系统或执行程序内对特定处理器功能的支持.
- 调试寄存器允许设置断点以用于调试程序和系统软件.
- GDTR, LDTR 和 IDTR 寄存器包含其各自表的线性地址和大小 (限制).
- 任务寄存器包含当前任务的 TSS 的线性地址和大小.
- 特定于型号的寄存器.

模型特定寄存器 (MSR) 是一组主要可供操作系统或执行程序 (即在特权级别 0 运行的代码) 使用的寄存器. 这些寄存器控制调试扩展, 性能监控计数器, 机器检查架构和内存类型范围 (MTRR) 等项目. 这些寄存器的数量和功能因 Intel 64 和 IA-32 处理器系列的不同成员而异.

## 1.2 实模式和保护模式转换

## 1.3 80x86系统指令寄存器

<!-- 了解和掌握相关寄存器:
* 标志寄存器 EFLAGS
* 内存管理寄存器, 包括 GDTR, LDTR, IDTR, TR
* 控制寄存器, 包括 CR0 至 CR3 -->

## 1.4 系统指令

<!-- 了解和掌握相关系统指令:
* LGDT
* SGDT
* LIDT
* SIDT
* LLDT
* SLDT
* LTR
* STR -->
