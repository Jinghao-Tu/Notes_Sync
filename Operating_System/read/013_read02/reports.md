---
author: '013-涂靖昊'
---

# 2 保护模式内存管理

## 2.1 内存管理概览

<!-- 
了解与掌握以下概念, 并掌握它们之间的转换:
- 逻辑地址 Logical Address
- 线性地址 Linear Address
- 物理地址 Physical Address
有关分段管理的内容
 -->

IA-32 架构的内存管理机制分为两部分: 分段和分页.  
分段提供了一种隔离各个代码, 数据和堆栈模块的机制, 以便多个程序 (或任务) 可以在同一处理器上运行而不会相互干扰.  
分页提供了一种实现传统的按需分页虚拟内存系统的机制, 其中程序执行环境的各个部分根据需要映射到物理内存中. 分页还可以用于提供多个任务之间的隔离.

当在保护模式下运行时, 必须使用某种形式的分段. 没有模式位可以禁用分段. 然而, 分页的使用是可选的.

<figure style="text-align: center;">
  <img src="images/img1.png" alt="Segmentation and Paging", width="", height="", >
  <figcaption>分段和分页示意图</figcaption>
</figure>

如图所示, 分段提供了一种将处理器的可寻址内存空间 (称为线性地址空间) 划分为更小的受保护地址空间 (称为段) 的机制.

逻辑地址转换为线性地址:

- 逻辑地址由段选择器和偏移量组成. 段选择器是段的唯一表示符. 除此之外, 它还提供描述符表 (如 GDT) 到称为段描述符的数据结构的偏移量. 每一个段都有一个段描述符, 它指定了段的大小, 段的访问权限和特权级别, 段类型以及该段的第一个字节在线性地址空间中的位置 (称为段的基地址).
- 逻辑地址的片一部分被添加到段的基地址上以定位段内的字节. 基地址加上偏移量就形成了处理器线性地址空间中的线性地址.

线性地址转换为物理地址:

1. 如果不使用分页, 那么处理器的线性地址空间直接映射到处理器的物理地址空间. 物理地址空间定义为处理器可以在其地址总线上生成的地址范围.
2. 分页:
   - 由于多任务计算系统通常定义的线性地址空间远大于一次性包含在物理内存中的经济可行性, 因此需要某种 "虚拟化" 线性地址空间的方法. 线性地址空间的虚拟化是通过处理器的分页机制来处理的.  
   - 分页支持 "虚拟内存" 环境, 其中使用少量物理内存 (RAM 和 ROM) 和一些磁盘存储来模拟大型线性地址空间. 使用分页时，每个段被分为页 (通常每个大小为 4 KB), 这些页存储在物理内存或磁盘上. 操作系统或执行程序维护一个页目录和一组页表来跟踪页面.
   - 当程序 (或任务) 尝试访问线性地址空间中的地址位置时, 处理器使用页目录和页表将线性地址转换为物理地址, 然后在内存的该地址上执行请求的操作 (读或写).

## 2.2 分段机制

<!-- 
了解以下分段模型:
- Basic Flat Model
- Protected Flat Model
- Multi-Segment Model
 -->

### 2.2.1 Basic Flat Model

Basic Flat Model 是最简单的系统内存模型, 其中操作系统和应用程序可以访问连续的, 未分段的地址空间. 在最大程度上, 这种 Basic Flat Model 向系统设计这和应用程序程序员隐藏了体系结构的分段机制.

<figure style="text-align: center;">
  <img src="images/img2.png" alt="Flat Model", width="", height="", >
  <figcaption>Flat Model</figcaption>
</figure>

要使用 IA-32 架构实现 Basic Flat Model, 必须至少创建 2 个段描述符, 一个用于引用代码段, 另一个用于引用数据段.  
ROM (EPROM) 一般位于物理地址空间的顶部, 因为处理器从 FFFF_FFF0H 开始执行. RAM (DRAM) 被放置在地址空间的底部, 因为复位初始化后 DS 数据段的初始基地址为 0.

### 2.2.2 Protected Flat Model

Protected Flat Model 与 Basic Flat Model 相似, 不同之处在于段限制设置为仅包含物理内存实际存在的地址范围.
如果尝试访问不存在的内存, 则会生成一般保护异常 (#GP). 该模型针对某些类型的程序错误提供了最低级别的硬件保护.

<figure style="text-align: center;">
  <img src="images/img3.png" alt="Protected Flat Model", width="", height="", >
  <figcaption>Protected Flat Model</figcaption>
</figure>
