---
title: 第八讲
---

## MIPS 基本流水线

### 3.1.2 流水线性能分析

三项性能指标: 吞吐率, 加速比和效率

1. 吞吐率: 是衡量流水线速度的重要指标

   - 吞吐率是指单位时间内流水线所完成的任务数或输出结果的数量.
   - 最大吞吐率 $T\!P_{max}$ 是指流水线在达到稳定状态后所得到的吞吐率.
   - 设流水线由 $m$ 段组成, 完成 $n$ 个任务的吞吐率称为实际吞吐率, 记作 $T\!P$.

    (1) 最大吞吐率

    - 假设流水线各段的时间相等, 均为 $\Delta t_0$, 则: $$ T\!P_{max}=\frac{1}{\Delta t_0} $$
    - 假设流水线各段时间不等, 第 $i$ 段时间为 $\Delta t_i$, 则: $$ T\!P_{max} = \frac{1}{max\{\Delta t_i\}} $$
    - 最大吞吐率取决于流水线中最慢一段所需的时间, 该段成为流水线的瓶颈.
    - 消除瓶颈的方法:
        - 细化瓶颈段
        - 重复设置瓶颈段

    (2) 实际吞吐率

    - 若各段时间相等 (假设均为 $\Delta t_0$), 则完成时间 $$ T_{\text{流水}} = m\Delta t_0 + (n-1)\Delta t_0 $$
    - 实际吞吐率 $$ \begin{align*}
        T\!P =& \frac{n}{T_{\text{流水}}}=\frac{n}{m \cdot \Delta t_0 + (n-1) \cdot \Delta t_0} \\
        =& \frac{1}{(1 + \frac{m-1}{n})\Delta t_0} = \frac{T\!P_{max}}{1+\frac{m-1}{n}}
    \end{align*} $$
    - 若各段时间不等 (假设第 $i$ 段为 $\Delta t_i$), 则完成时间 $$ T=\Sigma_{i=1}^m \Delta t_i + (n-1) \Delta t_j $$
    这里, $ \Delta t_j = max\{\Delta t_i\} $  
    实际吞吐率 $T\!P = \frac{n}{\Sigma_{i=1}^m \Delta t_i+ (n-1) \Delta t_j}$

2. 加速比

   - 加速比是指流水线速度与等功能的非流水线速度之比
   - 加速比 $S = T_{\text{非流水}}/T_{\text{流水}}$
   - 若流水线为 $m$ 段, 每段时间均为 $\Delta t_0$, 则
    $$T_{\text{非流水}} = nm\Delta t_0, T_{\text{流水}} = m\Delta t_0 + (n-1)\Delta t_0$$
    $$ S = \frac{mn}{m+n-1}=\frac{m}{1+\frac{m-1}{n}} $$

3. 效率

   - 从时-空图上看, 效率就是 $n$ 个任务所占的时空区与 $m$ 个段总的时空区之比
   - 根据这个定义, 可以计算流水线各段时间不等时的流水效率
    $$ E = \frac{n\text{个任务占用的时空区}}{m\text{个段总的时空区}} $$

4. 吞吐率, 加速比和效率的关系
    - $ E=n\Delta t_0 / T_{\text{流水}} = m n \Delta t_0 / (T_{\text{流水}}m) =S/m $
    - $ E = n\Delta t_0 / T_{\text{流水}} =(n/T_{\text{流水}}) \cdot \Delta t_0 = T\!P \Delta t_0 $

5. 有关流水线性能的若干问题
   - 流水线并流水线并不能减少 (而且一般是增加) 单条指令的执行时间, 但能够提高吞吐率
   - 增加流水线的深度可以提高流水线性能
   - 流水线深度受限于流水线的延迟和额外开销
   - 需要用高速锁存器作为流水线寄存器
     - Earle 锁存器
   - 指令之间存在的相关, 产生了流水线的冲突, 进而限制了流水线的性能

## 3.3 流水线中的冲突

1. 流水线冲突 (Pipeline Hazard)

    流水线冲突
    : 指相邻或相近的两条指令因存在某种关联, 后一条指令不能在原先指定的时钟周期开始执行.

    - 消除冲突的基本方法------暂停

    暂停流水线中某条指令及其后面所有指令的执行, 该指令之前的所有指令继续执行

2. 三种不同类型的冲突

   - 结构冲突 (Structural Hazard): 硬件资源不满足要求
   - 数据冲突 (Data Hazard): 要用到前面指令的结构
   - 控制冲突 (Control Hazard): 分支指令和其他会改变 PC 值的指令的冲突

### 3.3.1 流水线的结构冲突

1. 导致结构冲突的常见原因:

   - 功能部件不是全流水
   - 重复设置的资源数量不足

2. 实例: 当数据和指令存在同一存储器中时, 访存指令会引起存储器访问冲突.  
    解决方法:

   - I. 插入赞体内周期
   - II. 将指令存储器和数据存储器分离

3. 避免结构冲突的方法:

   - 所有功能单元完全流水化
   - 设置足够多的硬件资源

    但是硬件的代价很大!

4. 有些设计方案允许结构冲突存在

   - 降低成本
   - 减少功能单元的延迟

### 3.3.2 数据冲突

1. 简介
    : 产生原因: 当指令在流水线中重叠执行时, 流水线有可能改变指令读/写操作数的顺序, 使之不同于它们在非流水实现时的顺序, 这将导致数据冲突.

    : 消除方法: 向流水线中插入暂停周期

2. 通过定向技术减少数据冲突带来的暂停

